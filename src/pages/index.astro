---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import { sectionSchemas, getFieldType, getFieldPrefix } from "../data/resume-schema";

// Get all resume content
const allEntries = await getCollection("resume");

// Group entries by section folder (00-personal, 01-summary, etc.)
const sections = new Map<string, { header: any; items: any[] }>();

for (const entry of allEntries) {
  const [sectionFolder] = entry.id.split("/");

  if (!sections.has(sectionFolder)) {
    sections.set(sectionFolder, { header: null, items: [] });
  }

  const section = sections.get(sectionFolder)!;
  const fileName = entry.id.split("/").pop() || "";

  if (fileName.startsWith("00-")) {
    section.header = entry;
  } else {
    section.items.push(entry);
  }
}

// Sort sections and items
const sortedSections = [...sections.entries()]
  .sort(([a], [b]) => a.localeCompare(b))
  .map(([folder, { header, items }]) => ({
    folder,
    header,
    items: items.sort((a, b) => a.id.localeCompare(b.id)),
  }));

/**
 * Section Routing - Controls where each section appears in the layout
 *
 * To ADD a new section:
 *   1. Create folder in resume/sections/ (e.g., 06-certifications/)
 *   2. Add 00-certifications.md header with type, title, sidebar, fields
 *   3. Add item files (01-cert1.md, 02-cert2.md, etc.)
 *   4. Run `npm run sync` to regenerate schema
 *
 * To MOVE section to sidebar:
 *   - Add `sidebar: true` to the section's 00-*.md header file
 *
 * To MOVE section to main content:
 *   - Remove `sidebar: true` (or set to false) in the section's 00-*.md header
 *
 * To REMOVE a section:
 *   - Delete the folder from resume/sections/
 *   - Run `npm run sync`
 *
 * Section routing logic:
 *   - type: "personal" → Header (full width, top of page)
 *   - sidebar: true → Left sidebar column
 *   - Everything else → Main content column
 */
const headerSection = sortedSections.find(s => {
  const idx = parseInt(s.folder.split("-")[0], 10);
  return sectionSchemas[idx]?.type === "personal";
});
const sidebarSections = sortedSections.filter(s => {
  const idx = parseInt(s.folder.split("-")[0], 10);
  return sectionSchemas[idx]?.sidebar === true;
});
const mainSections = sortedSections.filter(s => {
  const idx = parseInt(s.folder.split("-")[0], 10);
  const schema = sectionSchemas[idx];
  return schema?.type !== "personal" && !schema?.sidebar;
});

// Helper to render markdown content to HTML
function renderContent(content: string): string {
  if (!content) return "";

  // Convert **bold** to <strong>
  let html = content.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");

  // Helper to clean list item text
  const cleanItem = (item: string) => item.replace(/^-\s*/, "").trim();

  // Split into sections by bold headers
  const sections = html.split(/(?=<strong>[^<]+:<\/strong>)/);

  return sections.map(section => {
    const headerMatch = section.match(/^<strong>([^<]+):<\/strong>/);
    if (headerMatch) {
      const header = headerMatch[1];
      const rest = section.replace(/^<strong>[^<]+:<\/strong>\s*/, "");
      const items = rest.split(/\n-\s*/).filter(Boolean);
      const listHtml = items.map(item => `<li>${cleanItem(item)}</li>`).join("\n");
      return `<div class="subsection"><h4>${header}</h4><ul>${listHtml}</ul></div>`;
    }
    // Plain list items
    const items = section.split(/\n-\s*/).filter(Boolean);
    if (items.length > 0) {
      const listHtml = items.map(item => `<li>${cleanItem(item)}</li>`).join("\n");
      return `<ul>${listHtml}</ul>`;
    }
    return section;
  }).join("\n");
}
---

<Layout title="Thy Do - Software Engineer">
  {/* Two-column layout */}
  <div class="layout">
    {/* Sidebar - Photo, Education & Skills */}
    <aside class="sidebar">
      {/* Profile Photo - add your image to public/photo.jpg */}
      <div class="profile-photo">
        <img src="/thydo/photo.jpg" alt="Profile photo" />
      </div>
      {sidebarSections.map(({ folder, header, items }) => {
        const schemaIndex = parseInt(folder.split("-")[0], 10);
        const schema = sectionSchemas[schemaIndex] || {};
        const sectionType = schema.type;
        const title = schema.title;
        const fields = schema.fields || {};
        const renderAsCategories = schema.renderAsCategories;

        return (
          <section class={`section section--${sectionType}`}>
            {title && <h2>{title}</h2>}

            {items.map((item) => {
              const data = item.data;
              const content = item.body;

              {/* Skills with categories */}
              if (renderAsCategories) {
                const categoryField = Object.keys(fields)[0];
                const skills = content?.replace(/^- /gm, "").split("\n").filter(Boolean).join(", ");
                return (
                  <div class="skill-category">
                    {data[categoryField] && <h4>{data[categoryField]}</h4>}
                    <span class="skill-list">{skills}</span>
                  </div>
                );
              }

              {/* Education */}
              const headerFields = Object.entries(fields).filter(([_, fc]) => getFieldType(fc) === "header");
              const subheaderFields = Object.entries(fields).filter(([_, fc]) => getFieldType(fc) === "subheader");
              const inlineFields = Object.entries(fields).filter(([_, fc]) => getFieldType(fc) === "inline");

              return (
                <article class="item item--compact">
                  {headerFields.map(([fieldName]) => {
                    const value = data[fieldName];
                    return value ? <h3>{value}</h3> : null;
                  })}
                  {subheaderFields.map(([fieldName]) => {
                    const value = data[fieldName];
                    return value ? <p class="subheader">{value}</p> : null;
                  })}
                  <p class="inline-info">
                    {inlineFields.map(([fieldName, fieldConfig], i) => {
                      const value = data[fieldName];
                      const prefix = getFieldPrefix(fieldConfig);
                      return value ? (
                        <>
                          {i > 0 && <span class="sep">|</span>}
                          <span>{prefix}{value}</span>
                        </>
                      ) : null;
                    })}
                  </p>
                </article>
              );
            })}
          </section>
        );
      })}
    </aside>

    {/* Main Content - Header, Summary, Experience, Projects */}
    <main class="main-content">
      {/* Header - Personal Info */}
      {headerSection && (
        <header class="personal">
          {headerSection.items.map((item) => {
            const data = item.data;
            return (
              <>
                {data.name && <h1>{data.name}</h1>}
                {data.title && <p class="job-title">{data.title}</p>}
                <p class="contact">
                  {data.email && <><a href={`mailto:${data.email}`}>{data.email}</a><span class="sep">|</span></>}
                  {data.GitHub && <><a href={`https://${data.GitHub}`} target="_blank">{data.GitHub}</a><span class="sep">|</span></>}
                  {data.LinkedIn && <a href={`https://${data.LinkedIn}`} target="_blank">{data.LinkedIn}</a>}
                </p>
              </>
            );
          })}
        </header>
      )}

      {mainSections.map(({ folder, header, items }) => {
        const schemaIndex = parseInt(folder.split("-")[0], 10);
        const schema = sectionSchemas[schemaIndex] || {};
        const sectionType = schema.type;
        const title = schema.title;
        const fields = schema.fields || {};

        return (
          <section class={`section section--${sectionType}`}>
            {title && <h2>{title}</h2>}

            {items.map((item) => {
              const data = item.data;
              const content = item.body;

              {/* Summary section */}
              if (sectionType === "plaintext") {
                return <p class="summary">{content}</p>;
              }

              {/* Experience, Projects */}
              const headerFields = Object.entries(fields).filter(([_, fc]) => getFieldType(fc) === "header");
              const subheaderFields = Object.entries(fields).filter(([_, fc]) => getFieldType(fc) === "subheader");
              const inlineFields = Object.entries(fields).filter(([_, fc]) => getFieldType(fc) === "inline");

              return (
                <article class="item">
                  {headerFields.map(([fieldName]) => {
                    const value = data[fieldName];
                    return value ? <h3>{value}</h3> : null;
                  })}

                  <div class="item-meta">
                    <div class="item-meta-left">
                      {subheaderFields.map(([fieldName]) => {
                        const value = data[fieldName];
                        return value ? <span class="subheader">{value}</span> : null;
                      })}
                    </div>
                    <div class="item-meta-right">
                      {inlineFields.map(([fieldName, fieldConfig], i) => {
                        const value = data[fieldName];
                        const prefix = getFieldPrefix(fieldConfig);
                        return value ? (
                          <>
                            {i > 0 && <span class="sep">|</span>}
                            <span class="inline-field">{prefix}{value}</span>
                          </>
                        ) : null;
                      })}
                    </div>
                  </div>

                  {content && <div class="content" set:html={renderContent(content)} />}
                </article>
              );
            })}
          </section>
        );
      })}
    </main>
  </div>
</Layout>
